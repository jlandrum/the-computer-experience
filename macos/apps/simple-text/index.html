<template>
  <app-simple-text>
    <menu-segment segment-id="finder">
      <menu-item title="File">
        <menu-dropdown>
          <menu-dropdown-item label="New" action="new"></menu-dropdown-item>
          <menu-divider></menu-divider>
          <menu-dropdown-item label="Save" action="save"></menu-dropdown-item>
          <menu-dropdown-item label="Open..." action="open"></menu-dropdown-item>
          <menu-divider></menu-divider>
          <menu-dropdown-item label="Save As..." action="save_as"></menu-dropdown-item>
          <menu-divider></menu-divider>
          <menu-dropdown-item label="Quit" action="quit"></menu-dropdown-item>
        </menu-dropdown>
      </menu-item>
      <menu-item title="Edit" disabled></menu-item>
      <menu-item title="Help" disabled></menu-item>
      <menu-spacer></menu-spacer>
    </menu-segment>
    <template window="editor">
      <editor-window>
        <mac-window resizable multiwin>
          <mac-window-chrome>
            <chrome-close></chrome-close>
            <span>Untitled</span>
            <chrome-shrink></chrome-shrink>
            <chrome-collapse></chrome-collapse>
          </mac-window-chrome>
          <mac-window-content>
            <ui-frame shallow>
              <ui-horizontal-scroller target="textarea"></ui-horizontal-scroller>
              <ui-vertical-scroller target="textarea"></ui-vertical-scroller>
              <textarea autocorrect="false" spellcheck="false"></textarea>
            </ui-frame>
          </mac-window-content>
        </mac-window>
      </editor-window>
    </template>
    <style>
      app-simple-text {
        & textarea {
          width: 100%;
          height: 100%;
          border: none;
          color: var(--text);
          font-size: 11px;
          padding: 8px;
          resize: none;
          outline: none;
          overflow: auto;
          box-sizing: border-box;
        }
      }
    </style>
  </app-simple-text>
</template>

<script>
  if (typeof SimpleText === 'undefined') {
    class SimpleText extends MacApplication {

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('about', this.showAbout);
      }
      
      get name() { return 'SimpleText' }

      get icon() { return 'apps/simple-text/icon.png' }

      onAction = (source, action, detail) => {
        ['menu', 'new', this.newWindow].act();
        ['menu', 'quit', this.exit].act();

        if (source === 'menu') {
          switch (action) {
            case 'about':
              this.showDialog('SimpleText');
              break;
            case 'new':
              this.newWindow();
              break;
            case 'open':
              MacApplication.spawn('file-picker', { type: 'load-file' })
                .then(filePicker => {
                  filePicker.addEventListener('select', (e) => {
                    const file = e.detail;
                    if (file instanceof File) {
                      this.activeWindow.openFile(file);
                    } else {
                      this.showDialog('Error: Cannot open folders as text');
                    }
                  });
              });
              break;
            case 'save':
              if (this.activeWindow.activeFile) {
                this.activeWindow.activeFile.write(this.activeWindow.text);
              } else {
                this.showDialog('Error: No file to save');
              }
              break;
            case 'save_as':
            MacApplication.spawn('file-picker', { type: 'save-file', file: this.activeWindow.activeFile })
                .then(filePicker => {
                  filePicker.addEventListener('select', (e) => {
                    const file = e.detail;
                    if (file instanceof File) {
                      file.write(this.activeWindow.text);
                      this.activeWindow.openFile(file);
                    } else {
                      this.showDialog('Error: Cannot save folders as text');
                    }
                  });
              });
              break;
          }        
        }
      }

      newWindow = (args) => {
        if (args?.file) {
          const explorer = new VDiskExplorer();
          const file = explorer.getFile(args.file);          
          const activeWindowForFile = this.getWindowControllers().find(window => window.activeFile === file);

          if (activeWindowForFile) {
            activeWindowForFile.focus();
            return;
          }

          const window = this.spawnWindowFromTemplate('editor');
          window.openFile(file);
        } else {
          const window = this.spawnWindowFromTemplate('editor');
        }
      }
    }

    class EditorWindow extends MacWindowController {
      #activeFile;

      constructor() {
        super();
      }

      openFile(file) {
        this.#activeFile = file;
        this.querySelector('textarea').value = file.read();
        this.querySelector('span').textContent = file.name;
        FinderApp?.setFileState?.(this.#activeFile?.path, true);
      }

      onClose() {
        FinderApp?.setFileState?.(this.#activeFile?.path, false);
      }

      get activeFile() {
        return this.#activeFile;
      }

      get text() {
        return this.querySelector('textarea').value;
      }
    }

    customElements.define('editor-window', EditorWindow);
    customElements.define('app-simple-text', SimpleText);
  }
</script>